---
layout: post
title:  Flowable代码片段
categories: [flowable]
excerpt: Flowable代码片段实例，可学习参考，直接复制
---
#### 判断流程定义中Task节点是否是会签
```java
if (userTask.getBehavior() instanceof ParallelMultiInstanceBehavior)
```

#### 强制结束任务而流程不往下执行
```java
// 以下参考源码  org.flowable.engine.impl.bpmn.behavior.MultiInstanceActivityBehavior.java
// cleanupMiRoot 方法
public class TestCommond implements Command<Execution>, Serializable {
    private String executioinId;
    public TestCommond(String executioinId){
        this.executioinId=executioinId;
    }
    @Override
    public Execution execute(CommandContext commandContext) {
        ExecutionEntityManager executionEntityManager = CommandContextUtil.getExecutionEntityManager(commandContext);
        ExecutionEntity executionEntity = executionEntityManager.findById(executioinId);
        List<ExecutionEntity> executionList=executionEntityManager.collectChildren(executionEntity);

        // 删除Task
        for (ExecutionEntity execution : executionList) {
            ExecutionEntity executionImpl = CommandContextUtil.getExecutionEntityManager(commandContext).findById(execution.getId());
            List<TaskEntity> taskEntityList=executionImpl.getTasks();
            for (TaskEntity taskEntity : taskEntityList) {
                CommandContextUtil.getVariableService().deleteVariablesByExecutionId(execution.getId());
                TaskHelper.deleteTask(taskEntity, null, false, false, false);
            }
        }

        // 删除 Execution
        ExecutionEntity multiInstanceRootExecution = (ExecutionEntity) getMultiInstanceRootExecution(executionEntity);
        FlowElement flowElement = multiInstanceRootExecution.getCurrentFlowElement();

        Collection<String> executionIdsNotToSendCancelledEventsFor = executionEntity.isMultiInstanceRoot() ? null : Collections.singletonList(executionEntity.getId());
        executionEntityManager.deleteChildExecutions(multiInstanceRootExecution, null, executionIdsNotToSendCancelledEventsFor, "Reason", true, flowElement);
        executionEntityManager.deleteRelatedDataForExecution(multiInstanceRootExecution, "MI_END");
        executionEntityManager.delete(multiInstanceRootExecution);

        return null;
    }

    protected DelegateExecution getMultiInstanceRootExecution(DelegateExecution executionEntity) {
        DelegateExecution multiInstanceRootExecution = null;
        DelegateExecution currentExecution = executionEntity;
        while (currentExecution != null && multiInstanceRootExecution == null && currentExecution.getParent() != null) {
            if (currentExecution.isMultiInstanceRoot()) {
                multiInstanceRootExecution = currentExecution;
            } else {
                currentExecution = currentExecution.getParent();
            }
        }
        return multiInstanceRootExecution;
    }
}
// 如下方式调用，传入 会签节点 父 ExecutionId
processEngine.getManagementService().executeCommand(new TestCommond("230013"));

```
